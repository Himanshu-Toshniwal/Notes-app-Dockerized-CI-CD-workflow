name: Security Scan & Cleanup

on:
  schedule:
    # Run every day at 3 AM UTC
    - cron: '0 3 * * *'
  workflow_dispatch: # Allow manual trigger

env:
  IMAGE_NAME: himanshutoshniwal7570/notesapp

jobs:
  daily-security-scan:
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      contents: read

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ” Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: ğŸ“¦ Pull latest image
        run: |
          docker pull ${{ env.IMAGE_NAME }}:latest || echo "Image not found, will scan built image"

      - name: ğŸ”¨ Build image for scanning
        run: |
          docker build . -t ${{ env.IMAGE_NAME }}:scan

      - name: ğŸ”’ Run Trivy vulnerability scan
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.IMAGE_NAME }}:scan
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: ğŸ“Š Upload Trivy results
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: 'trivy-results.sarif'

      - name: ğŸ“‹ Print vulnerability report
        run: |
          docker run --rm -v /var/run/docker.sock:/var/run/docker.sock \
            aquasec/trivy image --severity HIGH,CRITICAL \
            ${{ env.IMAGE_NAME }}:scan || true

      - name: ğŸ”” Notification
        if: always()
        run: |
          echo "âœ… Daily security scan completed"
          echo "ğŸ“… Timestamp: $(date)"
