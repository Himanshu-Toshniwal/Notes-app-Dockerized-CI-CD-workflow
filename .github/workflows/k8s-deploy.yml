name: K8s Local Deployment

on:
  workflow_run:
    workflows: ["Build, Test, Scan & Deploy"]
    types:
      - completed
    branches: [main]
  workflow_dispatch:
    inputs:
      action:
        description: 'Deployment action'
        required: true
        default: 'deploy'
        type: choice
        options:
          - deploy
          - undeploy
          - status
      namespace:
        description: 'K8s namespace'
        required: true
        default: 'notes-app'

jobs:
  k8s-deploy:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ðŸ”§ Setup kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'v1.28.0'
      
      - name: ðŸš€ Setup Kind (Local K8s)
        uses: helm/kind-action@v1.8.0
        with:
          cluster_name: notes-app-cluster
          config: |
            kind: Cluster
            apiVersion: kind.x-k8s.io/v1alpha4
            nodes:
            - role: control-plane
              kubeadmConfigPatches:
              - |
                kind: InitConfiguration
                nodeRegistration:
                  kubeletExtraArgs:
                    node-labels: "ingress-ready=true"
              extraPortMappings:
              - containerPort: 80
                hostPort: 80
                protocol: TCP
              - containerPort: 443
                hostPort: 443
                protocol: TCP
              - containerPort: 30000
                hostPort: 30000
                protocol: TCP
      
      - name: ðŸ“Š Cluster Info
        run: |
          kubectl cluster-info
          kubectl get nodes
          kubectl get namespaces
      
      - name: ðŸ”— Load Docker Image to Kind
        run: |
          # Pull the latest image
          docker pull ${{ secrets.DOCKERHUB_USERNAME }}/notesapp:latest
          
          # Load image into Kind cluster
          kind load docker-image ${{ secrets.DOCKERHUB_USERNAME }}/notesapp:latest --name notes-app-cluster
      
      - name: ðŸš€ Deploy to K8s
        if: ${{ github.event.inputs.action == 'deploy' || github.event.inputs.action == '' }}
        run: |
          cd k8s
          chmod +x deploy.sh
          
          echo "ðŸš€ Deploying Notes App to Kubernetes..."
          
          # Apply manifests
          kubectl apply -f namespace.yaml
          kubectl apply -f configmap.yaml
          kubectl apply -f persistent-volume.yaml
          kubectl apply -f deployment.yaml
          kubectl apply -f service.yaml
          kubectl apply -f hpa.yaml
          
          # Wait for deployment
          kubectl wait --for=condition=available --timeout=300s deployment/notes-app-deployment -n notes-app
      
      - name: ðŸ” Deployment Status
        run: |
          echo "ðŸ“Š Deployment Status:"
          kubectl get all -n notes-app
          
          echo ""
          echo "ðŸ“ Pod Logs:"
          kubectl logs -l app=notes-app -n notes-app --tail=20
          
          echo ""
          echo "ðŸŒ Service Endpoints:"
          kubectl get endpoints -n notes-app
      
      - name: ðŸ§ª Health Check
        run: |
          echo "ðŸ¥ Running health checks..."
          
          # Port forward for testing
          kubectl port-forward service/notes-app-service 3000:3000 -n notes-app &
          sleep 10
          
          # Test health endpoint
          curl -f http://localhost:3000/health || echo "Health check failed"
          
          # Test API
          curl -f http://localhost:3000/api/notes || echo "API test failed"
      
      - name: ðŸ—‘ï¸ Undeploy (if requested)
        if: ${{ github.event.inputs.action == 'undeploy' }}
        run: |
          echo "ðŸ—‘ï¸ Removing Notes App from Kubernetes..."
          kubectl delete namespace notes-app --ignore-not-found=true
      
      - name: ðŸ“Š Final Status
        run: |
          echo "## ðŸš€ K8s Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Cluster**: Kind (Local)" >> $GITHUB_STEP_SUMMARY
          echo "- **Namespace**: notes-app" >> $GITHUB_STEP_SUMMARY
          echo "- **Action**: ${{ github.event.inputs.action || 'deploy' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Image**: ${{ secrets.DOCKERHUB_USERNAME }}/notesapp:latest" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ” Resources:" >> $GITHUB_STEP_SUMMARY
          kubectl get all -n notes-app >> $GITHUB_STEP_SUMMARY || echo "No resources found" >> $GITHUB_STEP_SUMMARY